!function(){"use strict";var e,t,r,n,i={3976:function(e,t,r){async function n(e,t,r,n){let i,o=t.body.getReader(),a=!1,s=[],u=new Uint8Array(4*r),l=0;for(;!a;){let t=await o.read();if(a=t.done,t.done)break;let p=t.value;if(0==s.length){if(u.set(p.slice(0,Math.min(4*r-l,p.byteLength)),l),l+=p.byteLength,l<4*r)continue;{let e=new DataView(u.buffer);for(let t=0;t<r;t++)s.push(e.getUint32(4*t,!0));p=p.slice(4*r-l)}}s.length>0&&null==i&&(i=n(e,s)),null!=i&&(new Uint8Array(e.exports.memory.buffer,i,p.length).set(p),i+=p.length)}}r(5306),r(3948),r(285),r(1637),r(2472),r(8012),r(3462),r(3824);var i=r(1673);class o extends Error{constructor(e,t){super("Data version mismatch - expected ".concat(e,", actual ").concat(t)),this.expected=e,this.actual=t}}class a{constructor(e){this.dataVersion=e,this.UrlVersion=1}encode(e){var t;let r=new Uint8Array(5+9*e.legs.filter((e=>1==e.type)).length+5*e.legs.filter((e=>0==e.type)).length),n=new DataView(r.buffer);n.setUint8(0,e.legs.length),n.setUint32(1,e.legs.length>0?e.legs[0].plannedDeparture.getTime()/1e3:0,!0);let o=5;for(let r of e.legs)n.setUint8(o+0,r.type),n.setUint16(o+1,r.departureStop.stopId,!0),n.setUint16(o+3,r.arrivalStop.stopId,!0),o+=5,1===r.type&&(n.setUint16(o,(null===(t=r.route)||void 0===t?void 0:t.id)||0,!0),n.setUint16(o+2,r.tripId||0,!0),o+=4);return"".concat(1).concat(i.DS.fromUint8Array(r,!0),"!").concat(this.dataVersion)}decode(e){let t=parseInt(e.substr(0,1));if(1===t)return this.decodeV1(e);throw new Error("Unsupported version ".concat(t))}decodeV1(e){let[t,r]=e.substr(1).split("!");if(r!==this.dataVersion)throw new o(this.dataVersion,r);let n=i.DS.toUint8Array(t),a=new DataView(n.buffer),s=a.getUint8(0),u=new Date(1e3*a.getUint32(1,!0)),l=[],p=5;for(let e=0;e<s;e++){let e=a.getUint8(p+0),t=a.getUint16(p+1,!0),r=a.getUint16(p+3,!0);if(p+=5,1===e){let n=a.getUint16(p,!0),i=a.getUint16(p+2,!0);p+=4,l.push({type:e,departureStopId:t,arrivalStopId:r,routeId:n,tripId:i})}else l.push({type:e,departureStopId:t,arrivalStopId:r,routeId:null,tripId:null})}return{departureTime:u,version:1,legs:l}}}class s{constructor(e,t){this.routeNames=e,this.stops=t}getDiva(e){return this.stops[e][1]}getStop(e){if(e>this.stops.length)throw new Error("Invalid stop id ".concat(e));return{stopId:e,stopName:this.stops[e][0]}}getRoute(e){if(e>this.routeNames.length)throw new Error("Invalid route id ".concat(e));return{name:this.routeNames[e][0],id:e,color:this.routeNames[e].length>3?this.routeNames[e][3]:0==this.routeNames[e][2]?"c4121a":"",headsign:this.routeNames[e][1]}}}var u=r(9684);function l(e){let t=0;return t=0==e?64:1<<e-1,t}function p(e){const t=(0,u.yQ)("Europe/Vienna"),r=(0,u.iN)(e,t);return{unixTime:(0,u.ZG)({year:r.year,month:r.month,day:r.day,hours:0,minutes:0,seconds:0},t),dayOfWeek:l(r.dayOfWeek)}}class c{constructor(e,t){this.routingInstance=e,this.routeInfoStore=t,this.mappedRealtimeData={}}getDepartures(e){this.setRequest(e);let t=this.routingInstance.exports.get_departures(),r=new DataView(this.routingInstance.exports.memory.buffer,t,324),n=r.getUint32(0,!0),i=[];for(let e=0;e<n;e++){let t={route:this.routeInfoStore.getRoute(r.getUint16(4+16*e,!0)),stop:this.routeInfoStore.getStop(r.getUint16(6+16*e,!0)),trip:r.getUint32(8+16*e,!0),plannedDeparture:new Date(1e3*r.getUint32(12+16*e,!0)),delay:r.getInt16(16+16*e,!0)};i.push(t)}return i}setRequest(e){let t=this.routingInstance.exports.get_request_memory(),r=new DataView(this.routingInstance.exports.memory.buffer,t,168);r.setUint8(0,0),r.setUint8(1,Math.min(20,e.departureStops.length)),r.setUint8(2,1);let n=p(e.departureStops[0].departureTime);r.setUint8(3,n.dayOfWeek);for(let t=0;t<Math.min(20,e.departureStops.length);t++)r.setUint16(4+2*t,e.departureStops[t].stopId,!0);"number"==typeof e.arrivalStop&&r.setUint16(44,e.arrivalStop,!0);let i=n.unixTime/1e3;for(let t=0;t<Math.min(20,e.departureStops.length);t++){let i=(+e.departureStops[t].departureTime-n.unixTime)/1e3;r.setUint32(84+4*t,i,!0)}r.setUint32(164,i,!0)}route(e){if(e.departureStops.length!=e.departureTimes.length)throw new Error("departureStops and departureTimes must have the same length");performance.mark("routing-start"),this.setRequest({departureStops:e.departureStops.map(((t,r)=>({stopId:t,departureTime:e.departureTimes[r]}))),arrivalStop:e.arrivalStop});let t=this.routingInstance.exports.raptor();return performance.mark("routing-done"),performance.measure("routing","routing-start","routing-done"),console.log("routing took ".concat(performance.getEntriesByName("routing")[0].duration,"ms")),performance.clearMarks(),performance.clearMeasures(),this.readResults(this.routingInstance.exports.memory,t)}async updateRealtimeForStops(e){let t=new URLSearchParams;for(let r of e)t.append("diva",r.toString());let r=await fetch("https://realtime-api.grapp.workers.dev/ogd_realtime/monitor?".concat(t)),n=await r.json();for(let e of n.data.monitors)for(let t of e.lines){let r;if("1"==t.richtungsId)r=0;else{if("2"!=t.richtungsId)throw new Error("unknown richtungsId in monitor ".concat(t.richtungsId));r=1}let n=t.departures.departure.filter((e=>null!=e.departureTime.timeReal)).map((e=>new Date(e.departureTime.timeReal)));n.length>0&&this.upsertRealtimeData({diva:parseInt(e.locationStop.properties.name),linie:t.lineId,apply:!0,direction:r,timeReal:n})}}readLeg(e,t){var r;let n=new DataView(e,t,24),i=n.getUint16(4,!0),o=n.getUint16(6,!0),a=n.getUint32(8,!0),s=n.getUint32(12,!0),u={type:n.getUint32(0,!0),departureStop:this.routeInfoStore.getStop(i),arrivalStop:this.routeInfoStore.getStop(o),plannedDeparture:new Date(1e3*a),delay:n.getInt16(18,!0),arrivalTime:new Date(1e3*s),duration:1e3*(s-a),route:null,tripId:null,isRealtime:!1};if(1==u.type){let e=n.getUint16(16,!0);u.route=this.routeInfoStore.getRoute(e),u.tripId=n.getUint32(20,!0),u.isRealtime=(null===(r=this.mappedRealtimeData[u.route.id])||void 0===r?void 0:r.has(u.tripId))||!1}return u}readItinerary(e,t){let r=[],n=new DataView(e,t,244).getUint32(0,!0);for(let i=0;i<n;i++)r.push(this.readLeg(e,t+4+24*i));return{legs:r.reverse()}}readResults(e,t){let r=[],n=new DataView(e.buffer,t,1956).getUint32(0,!0);for(let i=0;i<n;i++){let n=this.readItinerary(e.buffer,t+4+244*i);r.push(n)}return r}readStoptimeUpdate(e,t){let r=new DataView(e,t,81),n=r.getUint16(0,!0),i=r.getUint16(2,!0),o=r.getInt16(4,!0);return{routeId:n,route:this.routeInfoStore.getRoute(n).name,trip:i,realtimeOffset:o}}getRealtimeUpdateResult(){let e=this.routingInstance.exports.get_stoptime_update_memory(),t=new DataView(this.routingInstance.exports.memory.buffer,e,81),r=t.getUint8(13),n=[];for(let i=0;i<r;i++){let r=this.readStoptimeUpdate(this.routingInstance.exports.memory.buffer,e+16+20+8*i);n.push(Object.assign(Object.assign({},r),{numMatches:t.getUint8(76+i)}))}return n}upsertRealtimeData(e){let t=this.routingInstance.exports.get_stoptime_update_memory(),r=new DataView(this.routingInstance.exports.memory.buffer,t,81);r.setUint32(0,e.diva,!0),r.setUint16(4,e.linie,!0),r.setUint8(6,e.direction);let n=p(e.timeReal[0]);r.setUint8(7,n.dayOfWeek),r.setUint32(8,n.unixTime/1e3,!0),r.setUint8(12,e.apply?1:0);let i=Math.min(e.timeReal.length,5);r.setUint8(13,i);for(let t=0;t<i;t++)r.setUint32(16+4*t,(+e.timeReal[t]-n.unixTime)/1e3,!0);this.routingInstance.exports.process_realtime();let o=this.getRealtimeUpdateResult();for(let e of o)e.numMatches>0&&(this.mappedRealtimeData[e.routeId]=this.mappedRealtimeData[e.routeId]||new Set,this.mappedRealtimeData[e.routeId].add(e.trip))}}class f{constructor(e,t){this.routeUrlEncoder=e,this.routeInfoStore=t}getRouteByUrl(e){return{legs:this.routeUrlEncoder.decode(e).legs.map((e=>({type:e.type,departureStop:this.routeInfoStore.getStop(e.departureStopId),arrivalStop:this.routeInfoStore.getStop(e.arrivalStopId),route:1==e.type?this.routeInfoStore.getRoute(e.routeId):null,tripId:e.tripId,plannedDeparture:new Date,arrivalTime:new Date,delay:0,duration:0,isRealtime:!1})))}}}let d,g,h=null,m=null,w=null;const S=new URL(r(717),r.b).toString().split("/").pop().replace(".bmp",""),y=new a(S),b=new class{constructor(){this.dataVersion=new URL(r(717),r.b).toString().split("/").pop().replace(".bmp","")}populateTimeZones(){return null==this.timezonesPromise&&(this.timezonesPromise=r.e(955).then(r.t.bind(r,6955,23)).then((e=>(0,u.wE)(e)))),this.timezonesPromise}async createRouteInfoStore(){let e=fetch(new URL(r(9826),r.b).toString()).then((e=>e.json())),t=fetch(new URL(r(3363),r.b).toString()).then((e=>e.json())),[n,i]=await Promise.all([e,t]);return new s(n,i)}async createRoutingInstance(){let[e,t]=await Promise.all([WebAssembly.instantiateStreaming(fetch(new URL(r(1645),r.b).toString())),fetch(new URL(r(717),r.b).toString())]);return await n(e.instance,t,11,((e,t)=>e.exports.raptor_allocate(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10]))),e.instance.exports.initialize(),e.instance}async getRoutingInstance(){return null==this.routingInstancePromise&&(this.routingInstancePromise=this.createRoutingInstance()),this.routingInstancePromise}async getRouteInfoStore(){return null==this.routeInfoStorePromise&&(this.routeInfoStorePromise=this.createRouteInfoStore()),this.routeInfoStorePromise}async createRoutingService(){let[e,t]=await Promise.all([this.getRoutingInstance(),this.getRouteInfoStore(),this.populateTimeZones()]);return new c(e,t)}async getRoutingService(){return null==this.routingServicePromise&&(this.routingServicePromise=this.createRoutingService()),this.routingServicePromise}async createRouteDetailsService(){let e=await this.getRouteInfoStore();return new f(new a(this.dataVersion),e)}async getRouteDetailsService(){return null==this.routeDetailsServicePromise&&(this.routeDetailsServicePromise=this.createRouteDetailsService()),this.routeDetailsServicePromise}};let I="",U={arrivalStopResults:[],departureStopResults:[],results:[],routeDetail:null};function v(e){let t=e(U);U=Object.assign(Object.assign({},U),t),self.postMessage([t,Object.keys(t)])}function R(e,t){if(null==d)return;let r,n=e.toLowerCase().replace(/ä/g,"a").replace(/ö/g,"o").replace(/ü/g,"u").replace(/ß/g,"ss").replace(/[^a-z0-9]/g," ").replace(/ +(?= )/g,"").trim();if(n==I)return;if(n.length==I.length+1&&n.startsWith(I))r=d.exports.stopsearch_step(n.charCodeAt(n.length-1));else{r=d.exports.stopsearch_reset();for(let e=0;e<n.length;e++)r=d.exports.stopsearch_step(n.charCodeAt(e))}I=n;let i=new DataView(d.exports.memory.buffer,r,8),o=i.getUint32(0,!0),a=i.getUint32(4,!0),s=new DataView(d.exports.memory.buffer,a,2*o),u=[];for(let e=0;e<o;e++){let t=s.getUint16(2*e,!0),r=g[t];u.push({id:t,name:r.name})}v((e=>({[t?"departureStopResults":"arrivalStopResults"]:u})))}async function D(){let e=await b.getRoutingService(),t=await b.getRouteInfoStore(),r=g[m].stopIds,n=g[w].stopIds[0],i=new Set;for(let o=0;o<10;o++){let o=e.route({arrivalStop:n,departureStops:r,departureTimes:r.map((()=>h))});v((()=>({results:o.map((e=>({itineraryUrlEncoded:y.encode(e),itinerary:e})))})));let a=o.reduce(((e,r)=>[...e,...r.legs.map((e=>t.getDiva(e.departureStop.stopId)))]),[]).filter((e=>!i.has(e)));if(0==a.length)break;await e.updateRealtimeForStops(Array.from(new Set(a).values()));for(let e of a)i.add(e)}}self.addEventListener("message",(e=>{(async function(e){switch(e.type){case 0:await async function(){if(d)return;let e=fetch(new URL(r(3369),r.b).toString()).then((e=>e.json())).then((e=>g=e)),[t,i]=await Promise.all([WebAssembly.instantiateStreaming(fetch(new URL(r(7981),r.b).toString())),fetch(new URL(r(4156),r.b).toString())]);await Promise.all([e,n(t.instance,i,4,((e,t)=>e.exports.stopsearch_allocate(t[0]/12,t[1],t[3]/2)))]),t.instance.exports.stopsearch_reset(),d=t.instance}();break;case 1:R(e.term,!0);break;case 2:R(e.term,!1);break;case 3:await async function(){await b.getRoutingService()}();break;case 4:await async function(e,t){m=e,w=t,h=new Date,await D()}(e.departure,e.arrival);break;case 5:await async function(e){null!=h&&(h=new Date(h.getTime()+e),null!=m&&null!=w&&await D())}(e.increment);break;case 6:await async function(e){let t=(await b.getRouteDetailsService()).getRouteByUrl(e);v((()=>({routeDetail:{itineraryUrlEncoded:e,itinerary:t}})))}(e.itineraryUrlEncoded)}})(e.data).catch((e=>console.error(e)))}))},717:function(e,t,r){e.exports=r.p+"data/8ed9cf35095596fb10f8.bmp"},9826:function(e,t,r){e.exports=r.p+"data/a8e8473b1d16b4f9ef85.json"},4156:function(e,t,r){e.exports=r.p+"data/5c1be65d275ef79bf954.bmp"},3369:function(e,t,r){e.exports=r.p+"data/8a796ee078429d5d441f.json"},3363:function(e,t,r){e.exports=r.p+"data/b77c6b31db0a6f0615e2.json"},1645:function(e,t,r){e.exports=r.p+"12bdd96cde5bfde3c874.wasm"},7981:function(e,t,r){e.exports=r.p+"8e9c9e7956c6c5bf6b4e.wasm"}},o={};function a(e){var t=o[e];if(void 0!==t)return t.exports;var r=o[e]={exports:{}};return i[e](r,r.exports,a),r.exports}a.m=i,a.x=function(){var e=a.O(void 0,[453,541],(function(){return a(3976)}));return a.O(e)},e=[],a.O=function(t,r,n,i){if(!r){var o=1/0;for(p=0;p<e.length;p++){r=e[p][0],n=e[p][1],i=e[p][2];for(var s=!0,u=0;u<r.length;u++)(!1&i||o>=i)&&Object.keys(a.O).every((function(e){return a.O[e](r[u])}))?r.splice(u--,1):(s=!1,i<o&&(o=i));if(s){e.splice(p--,1);var l=n();void 0!==l&&(t=l)}}return t}i=i||0;for(var p=e.length;p>0&&e[p-1][2]>i;p--)e[p]=e[p-1];e[p]=[r,n,i]},r=Object.getPrototypeOf?function(e){return Object.getPrototypeOf(e)}:function(e){return e.__proto__},a.t=function(e,n){if(1&n&&(e=this(e)),8&n)return e;if("object"==typeof e&&e){if(4&n&&e.__esModule)return e;if(16&n&&"function"==typeof e.then)return e}var i=Object.create(null);a.r(i);var o={};t=t||[null,r({}),r([]),r(r)];for(var s=2&n&&e;"object"==typeof s&&!~t.indexOf(s);s=r(s))Object.getOwnPropertyNames(s).forEach((function(t){o[t]=function(){return e[t]}}));return o.default=function(){return e},a.d(i,o),i},a.d=function(e,t){for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.f={},a.e=function(e){return Promise.all(Object.keys(a.f).reduce((function(t,r){return a.f[r](e,t),t}),[]))},a.u=function(e){return{453:"e7737a952cea1ab67ecf",541:"8c30cca3c6a86a72f776",955:"aca8258eee8d7b804046"}[e]+".bundle.js"},a.miniCssF=function(e){},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.p="/",function(){a.b=self.location+"";var e={976:1};a.f.i=function(t,r){e[t]||importScripts(a.p+a.u(t))};var t=self.webpackChunkpockmas=self.webpackChunkpockmas||[],r=t.push.bind(t);t.push=function(t){var n=t[0],i=t[1],o=t[2];for(var s in i)a.o(i,s)&&(a.m[s]=i[s]);for(o&&o(a);n.length;)e[n.pop()]=1;r(t)}}(),n=a.x,a.x=function(){return Promise.all([a.e(453),a.e(541)]).then(n)},a.x()}();
//# sourceMappingURL=0949a936359a36cb789e.bundle.js.map